# Generated by Shep Compiler
# App: SupportAI
# DO NOT EDIT - regenerate from .shep file

from fastapi import APIRouter, HTTPException
from typing import List
from .models import Company, KnowledgeBase, Conversation, Message, Escalation
from .ai_client import *  # AI functions

router = APIRouter()

# In-memory storage (replace with database)
company_db: dict[str, Company] = {}
knowledgebase_db: dict[str, KnowledgeBase] = {}
conversation_db: dict[str, Conversation] = {}
message_db: dict[str, Message] = {}
escalation_db: dict[str, Escalation] = {}


# Company routes
@router.get("/companys", response_model=List[Company])
async def list_companys():
    return list(company_db.values())

@router.get("/companys/{id}", response_model=Company)
async def get_company(id: str):
    if id not in company_db:
        raise HTTPException(status_code=404, detail="Company not found")
    return company_db[id]

@router.post("/companys", response_model=Company)
async def create_company(data: Company):
    company_db[data.id if hasattr(data, 'id') else str(len(company_db))] = data
    return data

@router.put("/companys/{id}", response_model=Company)
async def update_company(id: str, data: Company):
    if id not in company_db:
        raise HTTPException(status_code=404, detail="Company not found")
    company_db[id] = data
    return data

@router.delete("/companys/{id}")
async def delete_company(id: str):
    if id not in company_db:
        raise HTTPException(status_code=404, detail="Company not found")
    del company_db[id]
    return {"ok": True}

# KnowledgeBase routes
@router.get("/knowledgebases", response_model=List[KnowledgeBase])
async def list_knowledgebases():
    return list(knowledgebase_db.values())

@router.get("/knowledgebases/{id}", response_model=KnowledgeBase)
async def get_knowledgebase(id: str):
    if id not in knowledgebase_db:
        raise HTTPException(status_code=404, detail="KnowledgeBase not found")
    return knowledgebase_db[id]

@router.post("/knowledgebases", response_model=KnowledgeBase)
async def create_knowledgebase(data: KnowledgeBase):
    knowledgebase_db[data.id if hasattr(data, 'id') else str(len(knowledgebase_db))] = data
    return data

@router.put("/knowledgebases/{id}", response_model=KnowledgeBase)
async def update_knowledgebase(id: str, data: KnowledgeBase):
    if id not in knowledgebase_db:
        raise HTTPException(status_code=404, detail="KnowledgeBase not found")
    knowledgebase_db[id] = data
    return data

@router.delete("/knowledgebases/{id}")
async def delete_knowledgebase(id: str):
    if id not in knowledgebase_db:
        raise HTTPException(status_code=404, detail="KnowledgeBase not found")
    del knowledgebase_db[id]
    return {"ok": True}

# Conversation routes
@router.get("/conversations", response_model=List[Conversation])
async def list_conversations():
    return list(conversation_db.values())

@router.get("/conversations/{id}", response_model=Conversation)
async def get_conversation(id: str):
    if id not in conversation_db:
        raise HTTPException(status_code=404, detail="Conversation not found")
    return conversation_db[id]

@router.post("/conversations", response_model=Conversation)
async def create_conversation(data: Conversation):
    conversation_db[data.id if hasattr(data, 'id') else str(len(conversation_db))] = data
    return data

@router.put("/conversations/{id}", response_model=Conversation)
async def update_conversation(id: str, data: Conversation):
    if id not in conversation_db:
        raise HTTPException(status_code=404, detail="Conversation not found")
    conversation_db[id] = data
    return data

@router.delete("/conversations/{id}")
async def delete_conversation(id: str):
    if id not in conversation_db:
        raise HTTPException(status_code=404, detail="Conversation not found")
    del conversation_db[id]
    return {"ok": True}

# Message routes
@router.get("/messages", response_model=List[Message])
async def list_messages():
    return list(message_db.values())

@router.get("/messages/{id}", response_model=Message)
async def get_message(id: str):
    if id not in message_db:
        raise HTTPException(status_code=404, detail="Message not found")
    return message_db[id]

@router.post("/messages", response_model=Message)
async def create_message(data: Message):
    message_db[data.id if hasattr(data, 'id') else str(len(message_db))] = data
    return data

@router.put("/messages/{id}", response_model=Message)
async def update_message(id: str, data: Message):
    if id not in message_db:
        raise HTTPException(status_code=404, detail="Message not found")
    message_db[id] = data
    return data

@router.delete("/messages/{id}")
async def delete_message(id: str):
    if id not in message_db:
        raise HTTPException(status_code=404, detail="Message not found")
    del message_db[id]
    return {"ok": True}

# Escalation routes
@router.get("/escalations", response_model=List[Escalation])
async def list_escalations():
    return list(escalation_db.values())

@router.get("/escalations/{id}", response_model=Escalation)
async def get_escalation(id: str):
    if id not in escalation_db:
        raise HTTPException(status_code=404, detail="Escalation not found")
    return escalation_db[id]

@router.post("/escalations", response_model=Escalation)
async def create_escalation(data: Escalation):
    escalation_db[data.id if hasattr(data, 'id') else str(len(escalation_db))] = data
    return data

@router.put("/escalations/{id}", response_model=Escalation)
async def update_escalation(id: str, data: Escalation):
    if id not in escalation_db:
        raise HTTPException(status_code=404, detail="Escalation not found")
    escalation_db[id] = data
    return data

@router.delete("/escalations/{id}")
async def delete_escalation(id: str):
    if id not in escalation_db:
        raise HTTPException(status_code=404, detail="Escalation not found")
    del escalation_db[id]
    return {"ok": True}

# =============================================================================
# AI Routes
# =============================================================================

@router.post("/ai/message_sentiment")
async def ai_message_sentiment(data: dict):
    """Compute AI field: Message.sentiment"""
    try:
        result = await compute_message_sentiment(data)
        return {"result": result}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/ai/message_summary")
async def ai_message_summary(data: dict):
    """Compute AI field: Message.summary"""
    try:
        result = await compute_message_summary(data)
        return {"result": result}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/ai/rule_1")
async def ai_rule_1(data: dict):
    """AI rule: "Auto-escalate frustrated customers":"""
    try:
        message_content = data.get("message_content", "")
        result = await check_rule_1(message_content)
        return {"result": str(result).lower()}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/ai/rule_2")
async def ai_rule_2(data: dict):
    """AI rule: "Flag potential spam":"""
    try:
        message_content = data.get("message_content", "")
        result = await check_rule_2(message_content)
        return {"result": str(result).lower()}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

